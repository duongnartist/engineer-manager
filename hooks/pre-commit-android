#!/bin/bash
# Pre-commit hook cho Android Team

set -e

echo "🔍 Android pre-commit checks..."

# 1. Lint + Format
./gradlew ktlintFormat detekt || {
  echo "❌ Lint/Detekt failed"
  exit 1
}

# 2. Spelling check (basic - kiểm tra tên file/class có ký tự lạ)
git diff --cached --name-only | grep -E '\.kt$' | while read file; do
  if grep -nE "[^a-zA-Z0-9_]" "$file" | grep "class "; then
    echo "❌ Lỗi đặt tên trong file $file"
    exit 1
  fi
done

# 3. Security check (không commit secret)
if git diff --cached | grep -E "(API_KEY|PASSWORD|SECRET|TOKEN)"; then
  echo "❌ Phát hiện secret trong code!"
  exit 1
fi

# 4. Commit message check
MSG_FILE=$(git rev-parse --git-dir)/COMMIT_EDITMSG
MSG=$(head -n1 "$MSG_FILE")

if ! [[ $MSG =~ ^\[[A-Z]+-[0-9]+\]\ .+ ]]; then
  echo "❌ Commit message sai format."
  echo "✅ Định dạng đúng: [ABC-123] Nội dung commit"
  exit 1
fi

echo "✅ Android pre-commit passed!"